import os
import csv
import PyPDF2
import docx
from oletools.olevba import VBA_Parser

def detect_file_type(file_path):
    _, file_extension = os.path.splitext(file_path)
    return file_extension.lower()

def extract_pdf_features(file_path):
    features = {'NumPages': None, 'HasJS': None, 'NumParagraphs': None, 'HasMacros': None}
    with open(file_path, 'rb') as file:
        reader = PyPDF2.PdfReader(file)
        features['NumPages'] = len(reader.pages)
        features['HasJS'] = any('/JS' in page.get('/Resources', {}) for page in reader.pages)
    return features

def extract_docx_features(file_path):
    features = {'NumPages': None, 'HasJS': None, 'NumParagraphs': None, 'HasMacros': None}
    doc = docx.Document(file_path)
    features['NumParagraphs'] = len(doc.paragraphs)
    vbaparser = VBA_Parser(file_path)
    features['HasMacros'] = vbaparser.detect_vba_macros()
    return features

def extract_features(file_path):
    file_type = detect_file_type(file_path)
    if file_type == '.pdf':
        return extract_pdf_features(file_path)
    elif file_type == '.docx':
        return extract_docx_features(file_path)
    else:
        return {}

def write_features_to_csv(file_paths, output_csv):
    with open(output_csv, 'w', newline='') as csvfile:
        writer = csv.writer(csvfile)
        writer.writerow(['FileName', 'NumPages', 'NumParagraphs', 'HasJS', 'HasMacros', 'Legitimate'])
        for file_path in file_paths:
            features = extract_features(file_path)
            legitimate = 1 if 'legitimate' in file_path.lower() else 0  # Determine legitimate status based on folder name
            writer.writerow([
                os.path.basename(file_path),
                features.get('NumPages', ''),
                features.get('NumParagraphs', ''),
                features.get('HasJS', ''),
                features.get('HasMacros', ''),
                legitimate
            ])

def main():
    directories = ['legitimate', 'malicious']  # Directories to search for files
    output_csv = 'file_features.csv'

    # Gather all PDF and DOCX files from both directories
    file_paths = []
    for directory in directories:
        file_paths.extend(
            [os.path.join(directory, f) for f in os.listdir(directory) if detect_file_type(f) in ['.pdf', '.docx']]
        )

    # Extract features and write them to a CSV file
    write_features_to_csv(file_paths, output_csv)

if __name__ == '__main__':
    main()
